<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NHAFLOWER - Thanh toán</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="../assets/vendor/fontawesome-free/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/user/common.css" />
  </head>
  <body>
    <div
      class="container py-3 d-flex justify-content-center align-items-center"
      style="min-height: 100vh"
    >
      <div
        class="col-lg-6 col-md-8 col-sm-12 mx-auto bg-white rounded shadow p-4"
      >
        <a href="shopping_cart.html" class="btn btn-outline-primary mb-3"
          ><i class="fas fa-arrow-left"></i> Quay lại giỏ hàng</a
        >
        <h2 class="mb-4 text-center" style="font-size: 1.7rem">
          Xác nhận đơn hàng
        </h2>
        <div id="checkoutCart"></div>
        <form id="checkoutForm" class="mt-3">
          <div class="form-group mb-3">
            <label for="customerName">Họ tên</label>
            <input
              type="text"
              class="form-control form-control-sm rounded"
              id="customerName"
              required
            />
          </div>
          <div class="form-group mb-3">
            <label for="customerPhone">Số điện thoại</label>
            <input
              type="text"
              class="form-control form-control-sm rounded"
              id="customerPhone"
              required
            />
          </div>
          <div class="form-group mb-3">
            <label for="customerAddress">Địa chỉ giao hàng</label>
            <input
              type="text"
              class="form-control form-control-sm rounded"
              id="customerAddress"
              required
            />
          </div>
          <div class="form-group mb-3">
            <label for="paymentMethod">Phương thức thanh toán</label>
            <select
              class="form-control form-control-sm rounded"
              id="paymentMethod"
            >
              <option value="cod">Thanh toán khi nhận hàng</option>
              <option value="card">Thẻ tín dụng</option>
              <option value="paypal">PayPal</option>
            </select>
          </div>
          <button type="submit" class="btn btn-success w-100 py-2">
            Xác nhận đặt hàng
          </button>
        </form>
        <div id="checkoutResult" class="mt-3"></div>
      </div>
    </div>
    <script src="../assets/vendor/jquery/jquery.min.js"></script>
    <script>
      // Hiển thị giỏ hàng
      function renderCheckoutCart() {
        let cart = [];
        try {
          cart = JSON.parse(localStorage.getItem("nhaflower_cart")) || [];
        } catch (e) {
          cart = [];
        }
        if (!cart.length) {
          $("#checkoutCart").html(
            '<div class="alert alert-warning">Giỏ hàng trống!</div>'
          );
          $("#checkoutForm").hide();
          return;
        }
        let html = '<h5>Sản phẩm:</h5><ul class="list-group mb-3">';
        cart.forEach((item) => {
          html += `<li class="list-group-item d-flex justify-content-between align-items-center">
          <span>${item.name} (${item.quantity} x ${item.size})</span>
          <span>${Number(item.price).toLocaleString("vi-VN")} VNĐ</span>
        </li>`;
        });
        html += "</ul>";
        $("#checkoutCart").html(html);
      }
      renderCheckoutCart();

      // Xử lý submit đơn hàng
      $("#checkoutForm").on("submit", function (e) {
        e.preventDefault();
        const name = $("#customerName").val().trim();
        const phone = $("#customerPhone").val().trim();
        const address = $("#customerAddress").val().trim();
        const payment = $("#paymentMethod").val();
        let cart = [];
        try {
          cart = JSON.parse(localStorage.getItem("nhaflower_cart")) || [];
        } catch (e) {
          cart = [];
        }
        if (!cart.length) {
          $("#checkoutResult").html(
            '<div class="alert alert-danger">Giỏ hàng trống!</div>'
          );
          return;
        }
        // Lấy id khách hàng từ localStorage (giả sử lưu ở nhaflower_user)
        let user = null;
        try {
          user = JSON.parse(localStorage.getItem("nhaflower_user"));
        } catch (e) {
          user = null;
        }
        const id_khachhang =
          user && user.id_khachhang ? user.id_khachhang : null;
        if (!id_khachhang) {
          $("#checkoutResult").html(
            '<div class="alert alert-danger">Không tìm thấy thông tin khách hàng. Vui lòng đăng nhập lại!</div>'
          );
          return;
        }
        // Tính tổng tiền
        const tong_tien = cart.reduce(
          (sum, item) => sum + Number(item.price) * Number(item.quantity),
          0
        );
        // Chuyển đổi mảng sản phẩm sang định dạng backend mới
        const products = cart.map((item) => ({
          id: item.id,
          quantity: item.quantity,
          price: Number(item.price),
        }));
        // Gửi đơn hàng lên API mới
        $.ajax({
          url: "/NHAFLOWER/api/checkout.php",
          method: "POST",
          dataType: "json",
          data: {
            id_khachhang: id_khachhang,
            dia_chi_giao: address,
            products: JSON.stringify(products),
          },
          success: function (res) {
            if (res.success) {
              $("#checkoutResult").html(
                '<div class="alert alert-success">Đặt hàng thành công! Bạn có thể theo dõi đơn hàng trong trang cá nhân.</div>'
              );
              localStorage.removeItem("nhaflower_cart");
            } else {
              $("#checkoutResult").html(
                '<div class="alert alert-danger">' +
                  (res.message || "Đặt hàng thất bại!") +
                  "</div>"
              );
            }
          },
          error: function (xhr) {
            $("#checkoutResult").html(
              '<div class="alert alert-danger">Lỗi kết nối máy chủ!<br>' +
                (xhr.responseText ? xhr.responseText : "") +
                "</div>"
            );
          },
        });
      });
    </script>
  </body>
</html>
